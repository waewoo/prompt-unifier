# ============================================================================
# Pre-commit Configuration
# ============================================================================

fail_fast: true

repos:
  - repo: local
    hooks:
      # ====================================================================
      # File Hygiene - Using pre-commit-hooks installed via Poetry
      # ====================================================================
      - id: trailing-whitespace
        name: Quality - Trim trailing whitespace
        entry: poetry run trailing-whitespace-fixer
        language: system
        types: [text]
        exclude: (^\.|/\.|agent-os/)

      - id: end-of-file-fixer
        name: Quality - Fix end of files
        entry: poetry run end-of-file-fixer
        language: system
        types: [text]
        exclude: (^\.|/\.|agent-os/)

      - id: check-json
        name: Quality - Check JSON syntax
        entry: poetry run check-json
        language: system
        types: [json]

      - id: check-added-large-files
        name: Quality - Check for large files
        entry: poetry run check-added-large-files
        language: system
        args: ["--maxkb=15360"]
        exclude: (^\.|/\.|agent-os/)

      # ====================================================================
      # Markdown formatting
      # ====================================================================
      - id: mdformat
        name: Quality - Markdown formatter
        entry: poetry run mdformat
        language: system
        types: [markdown]
        args: [--wrap=100]
        exclude: (^\.|/\.|agent-os/|CHANGELOG\.md|docs/reference/cli-commands\.md)

      # ====================================================================
      # Python Code Quality - Ruff
      # ====================================================================
      - id: ruff-check
        name: Quality - Ruff linter
        entry: poetry run ruff check
        language: system
        types: [python]
        args: [--fix, --no-cache]
        pass_filenames: true

      - id: ruff-format
        name: Quality - Ruff formatter
        entry: poetry run ruff format
        language: system
        types: [python]
        args: [--no-cache]
        pass_filenames: true

      # ====================================================================
      # Type Checking - mypy
      # ====================================================================
      - id: mypy
        name: Quality - mypy type checker
        entry: poetry run mypy
        language: system
        types: [python]
        files: ^src/
        pass_filenames: false
        args: [src/]

      # ====================================================================
      # CI/CD Validation
      # ====================================================================
      - id: validate-gitlab-ci
        name: Quality - Validate GitLab CI config
        entry: npx gitlab-ci-local --preview
        language: system
        files: \.gitlab-ci\.yml$
        pass_filenames: false

      # ====================================================================
      # Security - Bandit & Secrets
      # ====================================================================
      - id: bandit
        name: Security - Bandit security linter
        entry: poetry run bandit
        language: system
        types: [python]
        args: ["-c", "pyproject.toml", "-r", "src/"]
        pass_filenames: false

      - id: detect-secrets
        name: Security - Detect secrets
        entry: poetry run python -c "import sys, subprocess; sys.exit(0) if sys.platform == 'win32' else sys.exit(subprocess.run(['poetry', 'run', 'detect-secrets-hook', '--baseline', '.secrets.baseline'] + sys.argv[1:]).returncode)"
        language: system
        exclude: |
          (?x)^(
          tests/fixtures/.*|
          \.secrets\.baseline|
          poetry\.lock
          )$
        pass_filenames: true

      - id: pip-audit
        name: Security - Dependency Vulnerabilities
        entry: bash -c 'cd "$0" && poetry run pip-audit' .
        language: system
        pass_filenames: false
        always_run: true
