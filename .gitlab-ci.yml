# GitLab CI/CD - Makefile Driven
#
# Logic is encapsulated in the Makefile (app-*, pkg-*, sec-*).
# CI Stages use functional names for better visibility in GitLab UI.

variables:
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"
  POETRY_NO_INTERACTION: "1"

image: $CI_IMAGE

# Noms de stages clairs et fonctionnels (lisibilité UI)
stages:
  - setup      # Install dependencies
  - quality    # Lint, Test, Sonar
  - security   # SAST, Secrets, Deps
  - build      # Build packages & Docs
  - release    # Publish & Tag
  - docs       # Deploy Pages

# ============================================================================
# CACHE & RULES
# ============================================================================

.cache-pull: &cache-pull
  cache:
    key:
      files: [poetry.lock]
    paths: [.venv/, .cache/pip]
    policy: pull

.rules:code: &rules-code
  - if: '$CI_COMMIT_BRANCH == "main"'
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

.rules:setup: &rules-setup
  - if: '$CI_COMMIT_TAG'
  - if: '$CI_COMMIT_BRANCH == "main"'
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ============================================================================
# STAGE: SETUP (Makefile: env-*)
# ============================================================================

setup-deps:
  stage: setup
  script:
    - make env-install
  cache:
    key:
      files: [poetry.lock]
    paths: [.venv/, .cache/pip]
    policy: pull-push
  artifacts:
    paths:
      - .venv/
    expire_in: 1 hour
  rules: *rules-setup

# ============================================================================
# STAGE: QUALITY (Makefile: app-*)
# ============================================================================

app-lint:
  stage: quality
  variables:
    SKIP: "validate-gitlab-ci"
  needs: ["setup-deps"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make app-lint
  rules: *rules-code

app-test:
  stage: quality
  needs: ["setup-deps"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make app-test
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths: [coverage.xml]
    expire_in: 1 day
  rules: *rules-code

app-sonar:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  needs: ["setup-deps", "app-test"]
  cache:
    key: "sonar-cache"
    paths: [.sonar/cache]
  script:
    - sonar-scanner
  rules: *rules-code
  allow_failure: true

# ============================================================================
# STAGE: SECURITY (Makefile: sec-*)
# ============================================================================

sec-all:
  stage: security
  needs: ["setup-deps"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make sec-all
  rules: *rules-code

# ============================================================================
# STAGE: BUILD (Makefile: pkg-build, docs-build)
# ============================================================================

pkg-build:
  stage: build
  needs: ["setup-deps"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make pkg-build
  artifacts:
    paths: [dist/]
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "main"'

docs-build:
  stage: build
  needs: ["setup-deps"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make docs-build
  artifacts:
    paths: [site/]
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - docs/**/*
        - mkdocs.yml
        - pyproject.toml

    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - docs/**/*
        - mkdocs.yml
    - when: manual
      allow_failure: true

# ============================================================================
# STAGE: RELEASE (Makefile: pkg-*)
# ============================================================================

pkg-ci-bump:
  stage: release
  # On attend que tout soit vert (qualité + sécu + build) avant de release
  needs: [setup-deps, app-test, app-lint, sec-all, pkg-build]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  variables:
    GIT_DEPTH: 0
  script:
    - make pkg-ci-bump
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /^(bump|chore\(release\))/i'
      when: manual
      allow_failure: true

pkg-gitlab-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  needs: ["pkg-build"]
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  script:
    # Utilise la CLI GitLab car c'est plus simple que curl/make pour les assets
    - release-cli create --name "Release $CI_COMMIT_TAG" --tag-name $CI_COMMIT_TAG

pkg-upload:
  stage: release
  needs: ["setup-deps", "pkg-gitlab-release"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  script:
    - make pkg-upload

# ============================================================================
# STAGE: DOCS (Deploy Pages)
# ============================================================================

pages:
  stage: docs
  needs: ["docs-build"]
  script:
    - if [ -d site ]; then mv site public; else mkdir -p public; fi
  artifacts:
    paths: [public]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_SERVER_HOST'
      when: always
    - if: '$CI_COMMIT_TAG'
    - when: never