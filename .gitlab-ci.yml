# GitLab CI/CD Pipeline for Prompt Unifier CLI
#
# Optimized pipeline with:
# - Quality checks first for fast feedback
# - Security scans after quality
# - Skip quality/security on tags (already tested on main)
# - Release notes automatically generated by Commitizen
# - Manual release for control over publication timing

variables:
  SECURE_LOG_LEVEL: "info"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POETRY_HOME: "$CI_PROJECT_DIR/.poetry"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"
  POETRY_NO_INTERACTION: "1"
  # Pre-commit cache configuration
  PRE_COMMIT_HOME: "$CI_PROJECT_DIR/.cache/pre-commit"

image: python:3.12

stages:
  - quality
  - security
  - build
  - release
  - deploy

# Global Cache Configuration
cache:
  key:
    files:
      - poetry.lock
      - .pre-commit-config.yaml
  paths:
    - .venv/
    - .cache/pip
    - .cache/pre-commit
    - .poetry/

before_script:
  - pip install --quiet poetry
  - poetry install --no-interaction --no-ansi

# ============================================================================
# QUALITY JOBS (Linting & Testing)
# ============================================================================

lint:
  stage: quality
  variables:
    SKIP: "validate-gitlab-ci"
  script:
    - echo "Running static analysis via Makefile (pre-commit)..."
    - make lint
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

test:
  stage: quality
  script:
    - make test
  coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
  artifacts:
    when: always
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - coverage.xml
      - report.xml
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

# ============================================================================
# SECURITY JOBS
# ============================================================================

security-scans:
  stage: security
  image: python:3.11-slim
  before_script:
    - apt-get update && apt-get install -y git make
    - pip install --quiet poetry pip-audit detect-secrets
    - poetry install --no-root --only main,dev
  script:
    - echo "Running comprehensive security scans via Makefile..."
    - make security
  artifacts:
    reports:
      sast: bandit-report.json
    paths:
      - bandit-report.json
      - pip-audit-report.json
    expire_in: 1 week
    when: always
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

sonar-scan:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  before_script: []
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner -X
      -Dsonar.qualitygate.wait=true
      -Dsonar.host.url="${SONAR_HOST_URL}"
  needs:
    - job: test
      artifacts: true
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  allow_failure: false

# ============================================================================
# BUILD JOBS
# ============================================================================

build-package:
  stage: build
  script:
    - make build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

build-docs:
  stage: build
  script:
    - make docs-build
  artifacts:
    paths:
      - site/
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ============================================================================
# RELEASE JOBS
# ============================================================================

auto-bump:
  stage: release
  image: python:3.12
  before_script:
    - pip install --quiet poetry commitizen
    - poetry install --no-interaction --no-ansi
    - apt-get update && apt-get install -y git-core
    - git config user.email "${GITLAB_USER_EMAIL}"
    - git config user.name "${GITLAB_USER_NAME}"
    - git remote set-url origin "https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
  script:
    - git checkout -B "${CI_COMMIT_REF_NAME}"
    - poetry run cz bump --changelog --yes || echo "⚠️ No version bump needed"
    - git push origin "${CI_COMMIT_REF_NAME}"
    - git push origin --tags
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /^bump:/'
      when: manual
      allow_failure: false
  needs: ["test", "build-package"]

create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  before_script:
    - apk add --no-cache python3 py3-pip git make
    - pip install --break-system-packages poetry commitizen
    - poetry install --no-interaction --no-ansi
  script:
    - make build
    - VERSION="${CI_COMMIT_TAG#v}"
    - make release-notes VERSION="$VERSION"
  release:
    tag_name: '$CI_COMMIT_TAG'
    name: 'Release $CI_COMMIT_TAG'
    description: './RELEASE_NOTES.md'
    assets:
      links:
        - name: 'Python Wheel (.whl)'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/prompt_unifier-${CI_COMMIT_TAG#v}-py3-none-any.whl'
          link_type: 'package'
        - name: 'Source Distribution (.tar.gz)'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/prompt_unifier-${CI_COMMIT_TAG#v}.tar.gz'
          link_type: 'package'
  artifacts:
    paths:
      - dist/
      - RELEASE_NOTES.md
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: on_success
  needs: ["build-package"]

# ============================================================================
# DEPLOY JOBS
# ============================================================================

publish-pypi:
  stage: deploy
  before_script:
    - pip install --upgrade poetry
    - poetry install --no-interaction --no-ansi
  script:
    - make build
    - poetry publish --username $PYPI_USER --password $PYPI_PASSWORD --no-interaction
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: on_success
  needs: ["create-release"]
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

pages:
  stage: deploy
  image: python:3.11
  before_script:
    - pip install --quiet poetry
    - poetry install --with docs --no-root
  script:
    - poetry run mkdocs build --site-dir public
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: on_success