# ==============================================================================
# GITLAB CI/CD - MAKEFILE DRIVEN (PLATINUM EDITION)
# ==============================================================================
# Image Reference: Built from Dockerfile.ci
# Contains: Python 3.12-slim, Make, Git, GCC, Poetry, Security Tools
#
# STRATEGY OVERVIEW:
#   - Merge Requests:  Build & Quality (Auto) | No Release stage.
#   - Main Branch:     Build (Manual Gate) -> Release (Auto, contingent on success).
#   - Tags:            Artifact Publication (Auto).
#
# CIRCUIT BREAKERS (Variables):
#   Set these variables to "true" to skip specific stages during dev/debug:
#   - SKIP_QUALITY, SKIP_SECURITY, SKIP_BUILD, SKIP_RELEASE
#
# SIMULATION:
#   - SIMULATE_MAIN="true": Forces the pipeline to behave like 'main' (Manual Build -> Release).
#     Useful for testing the full release process on feature branches without merging.
#
# REQUIREMENTS:
#   - CI Variables: SONAR_TOKEN, SONAR_HOST_URL, CI_PUSH_TOKEN (Write Access), PYPI_USER/PASSWORD
# ==============================================================================

# Global Optimization: Cancel old/redundant pipelines on the same branch
default:
  interruptible: true

# ==============================================================================
# GLOBAL WORKFLOW
# ==============================================================================
workflow:
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
    - if: '$CI_COMMIT_MESSAGE =~ /^(bump|chore\(release\)):/i'
      when: never
    - when: always

variables:
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"

  # Uses your custom "Golden Image" for performance (Tools pre-installed)
  CI_IMAGE: "registry.gitlab.com/waewoo/prompt-unifier/ci-base:latest"

image: $CI_IMAGE

stages:
  - setup    # Install project dependencies
  - quality  # Lint, Test, Sonar
  - security # SAST, Secrets, Dependency Audits
  - build    # Build packages (Wheel/Sdist) & Documentation
  - release  # Version Bump, Git Tag, Pages Deploy, Publish

# ==============================================================================
# TEMPLATES & CONFIGURATION
# ==============================================================================

# Cache Strategy: Pull-Push only in setup, Pull elsewhere for speed.
.cache-pull: &cache-pull
  cache:
    key:
      files: [poetry.lock]
    paths: [.venv/, .cache/pip]
    policy: pull

# Resilience: Retry failed jobs due to runner/network issues.
.network-retry: &network-retry
  retry:
    max: 2
    when: [runner_system_failure, stuck_or_timeout_failure, api_failure]

# ==============================================================================
# RULES & LOGIC
# ==============================================================================

.base-rules:
  # Note: The "Anti-Loop" logic is now handled globally in 'workflow:',
  # so we don't need it here anymore! simpler and safer.

  # 1. Standard Allow Rules
  - if: '$CI_COMMIT_TAG' # Needs to be allowed here for jobs to match
  - if: '$CI_COMMIT_BRANCH == "main"'
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  - if: '$SIMULATE_MAIN == "true"'

.rules:setup: &rules-setup
  - !reference [.base-rules]

.rules:quality: &rules-quality
  - if: '$CI_COMMIT_TAG'
    when: never
  - if: '$SKIP_QUALITY'
    when: never
  - !reference [.base-rules]

.rules:security: &rules-security
  - if: '$CI_COMMIT_TAG'
    when: never
  - if: '$SKIP_SECURITY'
    when: never
  - !reference [.base-rules]

.rules:build-strategy: &rules-build-strategy
  # 1. Circuit Breaker
  - if: '$SKIP_BUILD'
    when: never
  # 2. Dev Mode (MR): Run automatically.
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    when: on_success
  # 3. Release Mode (TAG): Must rebuild on Tag.
  - if: '$CI_COMMIT_TAG'
    when: on_success
  # 4. Prod Mode (Main): Manual Gate.
  - if: '$CI_COMMIT_BRANCH == "main" || $SIMULATE_MAIN == "true"'
    when: manual
    allow_failure: true

.rules:release-branch-strategy: &rules-release-branch-strategy
  # 1. Circuit Breaker
  - if: '$SKIP_RELEASE'
    when: never
  # 2. Safety: Never release from a Merge Request.
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    when: never
  # 3. Prod Mode (Main): Auto execution (wait for build).
  - if: '$CI_COMMIT_BRANCH == "main" || $SIMULATE_MAIN == "true"'
    when: on_success

.rules:release-tag-strategy: &rules-release-tag-strategy
  # 1. Official Release: Only triggered by strict SemVer tags.
  - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    when: on_success
  # 2. Safety: Ignore all other tags.
  - when: never

# ==============================================================================
# STAGE: SETUP
# ==============================================================================

setup-deps:
  stage: setup
  <<: *network-retry
  script:
    - make env-install
  cache:
    key:
      files: [poetry.lock]
    paths: [.venv/, .cache/pip]
    # Only job allowed to push to cache
    policy: pull-push
  artifacts:
    paths: [.venv/]
    expire_in: 1 hour
  rules: *rules-setup

# ==============================================================================
# STAGE: QUALITY
# ==============================================================================

app-lint:
  stage: quality
  variables:
    SKIP: "validate-gitlab-ci" # Skipping local hook, irrelevant in CI
  needs: ["setup-deps"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make app-lint
  rules: *rules-quality

app-test-linux:
  stage: quality
  needs: ["setup-deps"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make app-test
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths: [coverage.xml]
    expire_in: 1 day
  rules: *rules-quality

app-test-windows:
  stage: quality
  tags:
    - pc-windows
  image: null
  needs: []
  variables:
    PYTHONUNBUFFERED: "1"
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    POETRY_VIRTUALENVS_IN_PROJECT: "true"
  cache:
    key: "windows-poetry-cache"
    paths:
      - .cache/pip
      - .venv/
    policy: pull-push
  before_script:
    - python -m pip install poetry
    - python -m poetry --version
  script:
    - make env-install
    - make app-test
  artifacts:
    when: always
    reports:
      junit: report.xml
    paths:
      - coverage.xml
      - report.xml
    expire_in: 1 day
  rules:
    - if: '$SKIP_QUALITY'
      when: never
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"'
      when: manual
      allow_failure: true

app-sonar:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  variables:
      GIT_DEPTH: "0"
  needs:
    - job: setup-deps
    - job: app-test-linux
      optional: true
  cache:
    key: "sonar-cache"
    paths: [.sonar/cache]
  script:
    - sonar-scanner
  rules: *rules-quality

# ==============================================================================
# STAGE: SECURITY
# ==============================================================================

sec-all:
  stage: security
  needs: ["setup-deps"]
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make sec-all
  rules: *rules-security

# ==============================================================================
# STAGE: BUILD
# ==============================================================================

pkg-build:
  stage: build
  # Dependencies are enforced here.
  # 'optional: true' is REQUIRED to support SKIP_QUALITY/SKIP_SECURITY variables.
  needs:
    - job: setup-deps
      optional: false
    - job: app-test-linux
      optional: true
    - job: app-sonar
      optional: true
    - job: app-lint
      optional: true
    - job: sec-all
      optional: true
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make pkg-build
  artifacts:
    paths: [dist/]
    expire_in: 1 week
  rules: *rules-build-strategy

docs-build:
  stage: build
  needs:
    - job: setup-deps
      optional: false
    - job: app-lint
      optional: true
    - job: app-test-linux
      optional: true
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  script:
    - make docs-build
  artifacts:
    paths: [site/]
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - !reference [.rules:build-strategy]

# ==============================================================================
# STAGE: RELEASE
# ==============================================================================

# 1. PREPARE RELEASE
# Action: Bumps version, updates changelog, pushes Git Tag.
pkg-prepare-release:
  stage: release
  needs:
    - job: setup-deps
      optional: false
    - job: pkg-build
      optional: false
  <<: *cache-pull
  before_script:
    - test -d .venv || make env-install
  variables:
    GIT_DEPTH: 0 # Required for commitizen to read full history
  script:
    # Uses CI_PUSH_TOKEN to push back to repo
    - make pkg-prepare-release
  rules: *rules-release-branch-strategy

# 2. PAGES DEPLOY
# Action: Deploys static documentation to GitLab Pages.
pages:
  stage: release
  needs:
    - job: docs-build
      optional: false
  environment:
    name: documentation
    url: "https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME"
  script:
    - if [ -d site ]; then mv site public; else mkdir -p public; fi
  artifacts:
    paths: [public]
  rules: *rules-release-branch-strategy

# 3. GITLAB RELEASE NOTE (Tag)
pkg-gitlab-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs: ["pkg-build"]
  script:
    # --- DRY RUN LOGIC ---
    - >
      if [ "$DRY_RUN" == "true" ]; then
        echo "ðŸ›‘ DRY RUN ACTIVE: Simulating GitLab Release creation.";
        echo "Skipping command: release-cli create --name 'Release $CI_COMMIT_TAG' ...";
        exit 0;
      fi
    # --- REAL ACTION ---
    - release-cli create --name "Release $CI_COMMIT_TAG" --tag-name $CI_COMMIT_TAG
  rules: *rules-release-tag-strategy

# 4. PUBLISH PACKAGE (Tag)
pkg-publish-package:
  stage: release
  needs:
    - job: setup-deps
    - job: pkg-gitlab-release
    - job: pkg-build
      optional: false
  <<: [*cache-pull, *network-retry]
  environment:
    name: package
    url: "https://pypi.org/project/prompt-unifier/"
  before_script:
    - test -d .venv || make env-install
  script:
    # --- DRY RUN LOGIC ---
    - >
      if [ "$DRY_RUN" == "true" ]; then
        echo "ðŸ›‘ DRY RUN ACTIVE: Simulating PyPI Upload.";
        echo "Skipping command: make pkg-publish-package";
        exit 0;
      fi
    # --- REAL ACTION ---
    - make pkg-publish-package
  rules: *rules-release-tag-strategy
