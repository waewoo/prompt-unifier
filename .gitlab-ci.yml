# GitLab CI/CD Pipeline for Prompt Unifier CLI
#
# Optimized pipeline with:
# - Quality checks first for fast feedback
# - Security scans after quality
# - Skip quality/security on tags (already tested on main)
# - Release notes automatically generated by Commitizen
# - Manual release for control over publication timing

variables:
  SECURE_LOG_LEVEL: "info"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POETRY_HOME: "$CI_PROJECT_DIR/.poetry"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"
  POETRY_NO_INTERACTION: "1"
  # Pre-commit cache configuration
  PRE_COMMIT_HOME: "$CI_PROJECT_DIR/.cache/pre-commit"

image: python:3.12

stages:
  - quality
  - security
  - release

# Global Cache Configuration
cache:
  key:
    files:
      - poetry.lock
      - .pre-commit-config.yaml
  paths:
    - .venv/
    - .cache/pip
    - .cache/pre-commit
    - .poetry/

before_script:
  - pip install --quiet poetry
  - poetry install --no-interaction --no-ansi

# ============================================================================
# QUALITY JOBS (Linting & Testing)
# ============================================================================

lint:
  stage: quality
  variables:
    SKIP: "validate-gitlab-ci"
  script:
    - echo "Running static analysis via Makefile (pre-commit)..."
    # Install pre-commit (part of dev dependencies, but ensure hook envs are ready)
    # Note: 'make lint' runs 'poetry run pre-commit run --all-files'
    # We rely on the cache to speed up the hook environment setup
    - make lint
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

test:
  stage: quality
  script:
    - make test
  coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
  artifacts:
    when: always
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - coverage.xml
      - report.xml
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

# ============================================================================
# SECURITY JOBS
# ============================================================================

security-scans:
  stage: security
  image: python:3.11-slim
  before_script:
    - apt-get update && apt-get install -y git make
    - pip install --quiet poetry pip-audit detect-secrets
    - poetry install --no-root --only main,dev
  script:
    - echo "Running comprehensive security scans via Makefile..."
    - make security
  artifacts:
    reports:
      sast: bandit-report.json
    paths:
      - bandit-report.json
      - pip-audit-report.json
    expire_in: 1 week
    when: always
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# ============================================================================
# SONAR SCAN JOBS
# ============================================================================

sonar-scan:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  before_script: []
  variables:
    # Defined in GitLab CI/CD settings
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Needed for SonarScanner cache
    GIT_DEPTH: "0"  # Tells SonarScanner to fetch full history for accurate analysis
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner -X
      -Dsonar.qualitygate.wait=true
      -Dsonar.host.url="${SONAR_HOST_URL}"
  needs:
    - job: test
      artifacts: true
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  allow_failure: false # Will fail the pipeline if Quality Gate fails

# ============================================================================
# RELEASE JOBS
# ============================================================================

# Job 1: Version Bump (MANUAL)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# This job appears in every main pipeline but requires manual trigger.
# Click "Play" when you're ready to create a release.
#
# Actions:
# 1. Analyzes commits since last version (Conventional Commits)
# 2. Calculates new version (patch/minor/major) automatically
# 3. Updates pyproject.toml and __init__.py
# 4. Generates/updates CHANGELOG.md
# 5. Creates a commit + Git tag
# 6. Pushes to GitLab
# 7. Automatically triggers create-release via the tag

auto-bump:
  stage: release
  image: python:3.12
  before_script:
    - pip install --quiet poetry commitizen
    - poetry install --no-interaction --no-ansi
    - apt-get update && apt-get install -y git-core
    - git config user.email "${GITLAB_USER_EMAIL}"
    - git config user.name "${GITLAB_USER_NAME}"
    - git remote set-url origin "https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
  script:
    - git checkout -B "${CI_COMMIT_REF_NAME}"
    - |
      echo "ğŸš€ Running commitizen bump..."
      echo "This will:"
      echo "  - Analyze commits since last version"
      echo "  - Calculate new version (major/minor/patch)"
      echo "  - Update pyproject.toml and __init__.py"
      echo "  - Generate/update CHANGELOG.md"
      echo "  - Create a commit and tag"
      echo ""
      poetry run cz bump --changelog --yes || echo "âš ï¸  No version bump needed (no conventional commits found)"

      # Explicit push of branch AND tags
      echo ""
      echo "ğŸ“¤ Pushing changes and tags to GitLab..."
      git push origin "${CI_COMMIT_REF_NAME}"
      git push origin --tags
      echo "âœ… Done! The new tag will trigger the create-release job."
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /^bump:/'
      when: manual
      allow_failure: false
  needs: ["test"]

# Job 2: GitLab Release Creation (AUTOMATIC on tag)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# This job is automatically triggered when a v*.*.* tag is pushed.
# It creates a GitLab Release with packages and release notes.

create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  before_script:
    - apk add --no-cache python3 py3-pip git make
    - pip install --break-system-packages poetry commitizen
    - poetry install --no-interaction --no-ansi
  script:
    - make build
    - |
      VERSION="${CI_COMMIT_TAG#v}"
      make release-notes VERSION="$VERSION"
    - echo ""
    - echo "ğŸ“„ Release notes:"
    - echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    - cat RELEASE_NOTES.md
    - echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    - echo ""
    - echo "âœ… Packages built successfully:"
    - ls -lh dist/
  release:
    tag_name: '$CI_COMMIT_TAG'
    name: 'Release $CI_COMMIT_TAG'
    description: './RELEASE_NOTES.md'
    assets:
      links:
        - name: 'Python Wheel (.whl)'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/prompt_unifier-${CI_COMMIT_TAG#v}-py3-none-any.whl'
          link_type: 'package'
        - name: 'Source Distribution (.tar.gz)'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/prompt_unifier-${CI_COMMIT_TAG#v}.tar.gz'
          link_type: 'package'
  artifacts:
    paths:
      - dist/
      - RELEASE_NOTES.md
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: on_success
  needs: []

publish-pypi:
  stage: release
  before_script:
    - pip install --upgrade poetry
    - poetry install --no-interaction --no-ansi
  script:
    - make build
    - poetry publish --username $PYPI_USER --password $PYPI_PASSWORD --no-interaction
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: on_success
  needs: []
  artifacts:
    paths:
      - dist/
    expire_in: 1 week